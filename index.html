<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Game of Life</title>
        <link href="stillshit.css" type="text/css" rel="stylesheet" />
    </head>
    <body class="laboratory">
        <h1>The game of life <a href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life">(by Conway)</a></h1>
        <div class="container">
            <div class="leftPanel">
                <h2>Explanation</h2>
                <div class="description">
                    <p>A cell can have two states, dead (white) or alive (black). There are 3 rules that "run" the game:</p>
                    <ul>
                        <li>If an empty cell has exactly 3 cells alive, then it become alive as a "new-born" (reproduction)</li>
                        <li>If an living cell has 2 or 3 neighbours, it remains alive (survival)</li>
                        <li>Any other case, the cell dies (overpopulation) or remains empty (underpopulation therefore not reproducing)</li>
                    </ul>
                </div>

                <h2>Controls</h2>
                <div class="controls">
                    <p>You can click (or drag) to change a cell state, create some layout and see it is going</p>
                    <label for="btn_gameSpeed">Speed</label>
                    <input type="range" id="btn_gameSpeed" name="btn_gameSpeed" value="-32" min="-1000" max="-32"/>
                    <button id="btn_playpause">Play</button>
                    <button id="btn_nextStep">Next step</button>
                    <button id="btn_erase">Erase</button>
                    <button id="btn_reload">Reload</button>
                </div>

                <h2>Special layout</h2>
                <div class="sample-table">
                    <p>There are some particular layouts that are cool to watch.<br/>Re-create them and see by yourself ;)</p>
                    <div class="sample">
                        <h3 onclick="toggle(this)">Pulsar</h3>
                        <img class="hidden" src="./img/pulsar.png"/>
                    </div>
                    <div class="sample">
                        <h3 onclick="toggle(this)">Spaceship</h3>
                        <img class="hidden" src="./img/spaceship.png"/>
                    </div>
                    <div class="sample">
                        <h3 onclick="toggle(this)">Light weight spaceship</h3>
                        <img class="hidden" src="./img/light-weight-spaceship.png"/>
                    </div>
                    <div class="sample">
                        <h3 onclick="toggle(this)">Middle weight spaceship</h3>
                        <img class="hidden" src="./img/middle-weight-spaceship.png"/>
                    </div>
                    <div class="sample">
                        <h3 onclick="toggle(this)">Heavy weight spaceship</h3>
                        <img class="hidden" src="./img/heavy-weight-spaceship.png"/>
                    </div>
                    <div class="sample">
                        <h3 onclick="toggle(this)">Penta-decathlon</h3>
                        <img class="hidden" src="./img/penta-decathlon.png"/>
                    </div>
                    <div class="sample">
                        <h3 onclick="toggle(this)">Spaceship launcher</h3>
                        <img class="hidden" src="./img/spaceship_launcher.png"/>
                    </div>
                </div>
            </div>
            <div id="petriplate" class="petriplate"></div>
       </div>

        <script src="https://cdn.jsdelivr.net/npm/p5@1.3.1/lib/p5.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <script src="Cell.js"></script>
        <script src="PetriPlate.js"></script>
        <script>
            var isPlayed = false, interval = null;

            var sample = new PetriPlate(60);

            /** Buttons **/

            $('#btn_erase').click(()=>{
                isPlayed = false;
                for(let i = 0 ; i < sample.size; i++){
                    for(let j = 0 ; j < sample.size; j++){
                        sample.cells[i][j].state = Cell.STATE_DEAD;
                    }
                }
                sample.generationNumber = 0;
            });

            $('#btn_playpause').click(()=>{
                isPlayed = !isPlayed;
            });

            $('#btn_gameSpeed').change(()=>{
                $('label[for="btn_gameSpeed"]').text('Speed');
                clearInterval(interval);
                interval = null;
            });

            $('#btn_reload').click(()=>{
                isPlayed = false;
                sample = new PetriPlate(60);
            });

            $('#btn_nextStep').click(()=>{
                isPlayed = false;
                sample.nextStep();
            });

            /** P5 Rendering **/

            function setup(){
                const CANVAS_SIZE = 600;

                let canvas = createCanvas(CANVAS_SIZE, CANVAS_SIZE+Cell.WIDTH);
                //canvas.position(CANVAS_SIZE/4, 0);
                canvas.parent('petriplate');
                background(200, 200, 200);
            }

            var previousCellUnderMouse = null;

            function draw() {
                sample.draw();
                startOrStopGame();

                let currentCellUnderMouse = getCellUnderMouse();

                if(mouseIsPressed && currentCellUnderMouse !== null && currentCellUnderMouse !== previousCellUnderMouse){
                    currentCellUnderMouse.state = currentCellUnderMouse.state === Cell.STATE_ALIVE ? Cell.STATE_DEAD : Cell.STATE_ALIVE;
                    previousCellUnderMouse = currentCellUnderMouse;
                }
            }

            function getCellUnderMouse(){
                if(mouseX > 0 && mouseY > 0){
                    let indexX = ceil(mouseY / Cell.WIDTH)-1;
                    let indexY = ceil(mouseX / Cell.WIDTH)-1;
                    if(indexX < sample.size && indexY < sample.size) {
                        //console.log(indexX,indexY, sample.cells[indexX][indexY]);
                        return sample.cells[indexX][indexY];
                    }
                }
                return null;
            }

            /** FrontEnd **/

            function toggle(e){
                let img = $(e).first().next("img");
                if(img.hasClass("hidden")) {
                    img.removeClass("hidden");

                } else {
                    img.addClass("hidden");
                }
            }

            function startOrStopGame(){
                $('#btn_playpause').text(isPlayed ? 'Pause' : 'Play');
                if(isPlayed && interval === null) {
                    interval = setInterval(()=>{
                        sample.nextStep();
                    }, parseInt($("#btn_gameSpeed").val())*-1);
                } else if(!isPlayed) {
                    clearInterval(interval);
                    interval = null;
                }
            }
        </script>
    </body>
</html>